<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Opensess-svn] r20 - in trunk: . openSess print
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/opensess-svn/2005-April/index.html" >
   <LINK REL="made" HREF="mailto:opensess-svn%40lists.berlios.de?Subject=Re%3A%20%5BOpensess-svn%5D%20r20%20-%20in%20trunk%3A%20.%20openSess%20print&In-Reply-To=%3C200504261354.j3QDs1bk027877%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000014.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Opensess-svn] r20 - in trunk: . openSess print</H1>
    <B>Andreas Wickner at BerliOS</B> 
    <A HREF="mailto:opensess-svn%40lists.berlios.de?Subject=Re%3A%20%5BOpensess-svn%5D%20r20%20-%20in%20trunk%3A%20.%20openSess%20print&In-Reply-To=%3C200504261354.j3QDs1bk027877%40sheep.berlios.de%3E"
       TITLE="[Opensess-svn] r20 - in trunk: . openSess print">awickner at sheep.berlios.de
       </A><BR>
    <I>Tue Apr 26 15:54:01 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000014.html">[Opensess-svn] r19 - trunk/openSess
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15">[ date ]</a>
              <a href="thread.html#15">[ thread ]</a>
              <a href="subject.html#15">[ subject ]</a>
              <a href="author.html#15">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: awickner
Date: 2005-04-26 15:53:57 +0200 (Tue, 26 Apr 2005)
New Revision: 20

Added:
   trunk/openSess/GenericEditWindow.java
   trunk/openSess/HTMLPrinter.java
   trunk/openSess/Locations.java
   trunk/openSess/Times.java
   trunk/print/
   trunk/print/Details.xsl
   trunk/print/Overview.xsl
Removed:
   trunk/openSess/EditTopicWindow.java
Modified:
   trunk/openSess/MainWindow.java
   trunk/openSess/ShowSolutionWindow.java
   trunk/openSess/Solution.java
   trunk/openSess/SolutionPanel.java
   trunk/openSess/Solver.java
   trunk/openSess/SolverConstructor.java
Log:
- Fixed bug in role assignments that produced bad solutions 
  when different values are specified for minimum and maximum role occurences
- Initial support for printing (still mostly useless)

Deleted: trunk/openSess/EditTopicWindow.java
===================================================================
--- trunk/openSess/EditTopicWindow.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/EditTopicWindow.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -1,45 +0,0 @@
-
-package openSess;
-import javax.swing.JFrame;
-
-/*
- * Copyright 2005 Andreas Wickner
- * 
- * Created:     15.02.2005
- * Revision ID: $Id$
- * 
- * This file is part of OpenSess.
- * OpenSess is free software; you can redistribute it and/or modify it 
- * under the terms of the GNU General Public License as published by 
- * the Free Software Foundation; either version 2 of the License, or 
- * (at your option) any later version.
- *
- * OpenSess is distributed in the hope that it will be useful, but 
- * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY 
- * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License 
- * for more details.
- *
- * You should have received a copy of the GNU General Public License along 
- * with OpenSess; if not, write to the Free Software Foundation, Inc., 
- * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA 
- */
-
-/**
- * An EditTopicWindow is simply a ListEditWindow.
- * 
- * @author andreas
- */
-public class EditTopicWindow
-  extends ListEditWindow
-{
-  /**
-   * Construct a new EditTopicWindow.
-   * 
-   * @param frame
-   */
-  public EditTopicWindow(JFrame frame)
-  {
-    super(frame, &quot;Edit Topic&quot;);
-  }
-}
-

Copied: trunk/openSess/GenericEditWindow.java (from rev 10, trunk/openSess/EditTopicWindow.java)
===================================================================
--- trunk/openSess/EditTopicWindow.java	2005-03-04 18:45:41 UTC (rev 10)
+++ trunk/openSess/GenericEditWindow.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -0,0 +1,45 @@
+
+package openSess;
+import javax.swing.JFrame;
+
+/*
+ * Copyright 2005 Andreas Wickner
+ * 
+ * Created:     15.02.2005
+ * Revision ID: $Id$
+ * 
+ * This file is part of OpenSess.
+ * OpenSess is free software; you can redistribute it and/or modify it 
+ * under the terms of the GNU General Public License as published by 
+ * the Free Software Foundation; either version 2 of the License, or 
+ * (at your option) any later version.
+ *
+ * OpenSess is distributed in the hope that it will be useful, but 
+ * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY 
+ * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License 
+ * for more details.
+ *
+ * You should have received a copy of the GNU General Public License along 
+ * with OpenSess; if not, write to the Free Software Foundation, Inc., 
+ * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA 
+ */
+
+/**
+ * An GenericEditWindow is simply a ListEditWindow.
+ * 
+ * @author andreas
+ */
+public class GenericEditWindow
+  extends ListEditWindow
+{
+  /**
+   * Construct a new GenericEditWindow.
+   * 
+   * @param frame
+   */
+  public GenericEditWindow(JFrame frame, String title)
+  {
+    super(frame, title);
+  }
+}
+

Added: trunk/openSess/HTMLPrinter.java
===================================================================
--- trunk/openSess/HTMLPrinter.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/HTMLPrinter.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -0,0 +1,86 @@
+/*
+ * Copyright 2005 Andreas Wickner
+ * 
+ * Created:     2005-04-19 
+ * Revision ID: $Id$
+ * 
+ * This file is part of OpenSess.
+ * OpenSess is free software; you can redistribute it and/or modify it 
+ * under the terms of the GNU General Public License as published by 
+ * the Free Software Foundation; either version 2 of the License, or 
+ * (at your option) any later version.
+ *
+ * OpenSess is distributed in the hope that it will be useful, but 
+ * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY 
+ * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License 
+ * for more details.
+ *
+ * You should have received a copy of the GNU General Public License along 
+ * with OpenSess; if not, write to the Free Software Foundation, Inc., 
+ * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA 
+ */
+package openSess;
+
+import java.awt.Color;
+import java.awt.Dimension;
+import java.awt.Graphics;
+import java.awt.Graphics2D;
+import java.awt.print.PageFormat;
+import java.awt.print.Printable;
+import java.awt.print.PrinterException;
+import java.io.Serializable;
+
+import javax.swing.JEditorPane;
+import javax.swing.RepaintManager;
+
+/**
+ * @author andreas
+ *
+ */
+public class HTMLPrinter
+  extends JEditorPane 
+  implements Printable, Serializable
+{
+  public HTMLPrinter(String html)
+  {
+    setContentType(&quot;text/html&quot;);
+    getDocument().putProperty(&quot;IgnoreCharsetDirective&quot;, new Boolean(true));
+    setText(html);
+    setEditable(false);
+    setSize(500,500);
+  }
+  
+  public int print(Graphics g, PageFormat pf, int pageIndex)
+      throws PrinterException
+  {
+    System.out.println(&quot;HTMLPrinter.print&quot;);
+    Graphics2D g2 = (Graphics2D) g;
+    g2.setColor(Color.black);
+
+    RepaintManager.currentManager(this).setDoubleBufferingEnabled(false);
+    Dimension d = this.getSize();
+    double panelWidth = d.width;
+    double panelHeight = d.height;
+    System.out.println(&quot;w &quot; + panelWidth + &quot;, h &quot; + panelHeight);
+    double pageWidth = pf.getImageableWidth();
+    double pageHeight = pf.getImageableHeight();
+    System.out.println(&quot;iw &quot; + pageWidth + &quot;, ih &quot; + pageHeight);
+    double scale = pageWidth / panelWidth;
+    System.out.println(&quot;scale &quot; + scale);
+    int totalNumPages = (int) Math.ceil(scale * panelHeight / pageHeight);
+
+    System.out.println(&quot;total &quot; + totalNumPages + &quot;, index &quot; + pageIndex);
+    
+    // Check for empty pages
+    if (pageIndex &gt;= totalNumPages)
+      return Printable.NO_SUCH_PAGE;
+
+    g2.translate(pf.getImageableX(), pf.getImageableY());
+    g2.translate(0f, -pageIndex * pageHeight);
+    g2.scale(scale, scale);
+    this.paint(g2);
+
+    return Printable.PAGE_EXISTS;
+  }
+}
+

Added: trunk/openSess/Locations.java
===================================================================
--- trunk/openSess/Locations.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/Locations.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -0,0 +1,107 @@
+/*
+ * Copyright 2005 Andreas Wickner
+ * 
+ * Created:     2005-04-17 
+ * Revision ID: $Id$
+ * 
+ * This file is part of OpenSess.
+ * OpenSess is free software; you can redistribute it and/or modify it 
+ * under the terms of the GNU General Public License as published by 
+ * the Free Software Foundation; either version 2 of the License, or 
+ * (at your option) any later version.
+ *
+ * OpenSess is distributed in the hope that it will be useful, but 
+ * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY 
+ * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License 
+ * for more details.
+ *
+ * You should have received a copy of the GNU General Public License along 
+ * with OpenSess; if not, write to the Free Software Foundation, Inc., 
+ * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA 
+ */
+package openSess;
+
+import java.io.PrintWriter;
+
+import javax.swing.DefaultListModel;
+
+/**
+ * @author andreas
+ *
+ */
+public class Locations
+  implements XMLStateSaving
+{
+  private DefaultListModel names;
+
+  /**
+   * Constructs a new Locations object.
+   * 
+   * @param dimLocations the number of locations.
+   */
+  public Locations(int dimLocations)
+  {
+    names = new DefaultListModel();
+    
+    for (int p = 0; p &lt; dimLocations; p++)
+      names.addElement(&quot;Location &quot; + (p+1));
+  }
+
+
+  /**
+   * Returns the number of locations.
+   * 
+   * @return the number of locations.
+   */
+  public int getNumber()
+  {
+    return names.getSize();
+  }
+  
+  /**
+   * Returns all location names as a DefaultListModel.
+   * 
+   * @return a list of all location names.
+   */
+  public DefaultListModel getNames()
+  {
+    return names;
+  }
+  
+  /**
+   * Returns the name of the location with a given index.
+   * 
+   * @param index the index of the location
+   * @return the name of the location.
+   */
+  public String getName(int index)
+  {
+    return (String)names.getElementAt(index);
+  }
+  
+  /**
+   * Set the name of a location.
+   * 
+   * @param location the location number.
+   * @param name     the new name.
+   */
+  protected void setName(int location, String name)
+  {
+    // set a user&#180;s name
+    names.setElementAt(name, location);
+  }
+  
+  /**
+   * Save the Locations data in XML form.
+   */
+  public void save(PrintWriter stream, int level)
+  {
+    Indenter.println(stream, level, &quot;&lt;locations&gt;&quot;);
+
+    for (int p = 0;  p &lt; getNumber();  ++p)
+      Indenter.println(stream, level+1, &quot;&lt;location name=\&quot;&quot; + getName(p) + &quot;\&quot;/&gt;&quot;);
+    
+    Indenter.println(stream, level, &quot;&lt;/locations&gt;&quot;);
+  }
+
+}

Modified: trunk/openSess/MainWindow.java
===================================================================
--- trunk/openSess/MainWindow.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/MainWindow.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -32,7 +32,7 @@
  * Copyright 2005 Andreas Wickner
  * 
  * Created:     2005-02-12
- * Revision ID: $Id: MainWindow.java 10 2005-03-04 18:45:41Z awickner $
+ * Revision ID: $Id$
  * 
  * This file is part of OpenSess.
  * OpenSess is free software; you can redistribute it and/or modify it 
@@ -66,7 +66,8 @@
   private final String       fileSuffix  = &quot;ose&quot;;
   private JFrame             frame;
   private JLabel             configInfo;
-  private ObjectPanel        topicPanel, personPanel, rolePanel;
+  private ObjectPanel        topicPanel, personPanel, rolePanel, 
+  													 locationPanel, timePanel;
   private SolutionPanel      solutionPanel;
   private JFileChooser       fileChooser;
   private GlobalNewWindow    globalNewWindow;
@@ -272,7 +273,7 @@
     rootPanel.add(objectPanel, rc);
 
     // Set up the topic panel
-    topicPanel = new ObjectPanel(&quot;Topics&quot;, new EditTopicWindow(frame), solver, this);
+    topicPanel = new ObjectPanel(&quot;Topics&quot;, new GenericEditWindow(frame, &quot;Edit Topic&quot;), solver, this);
     objectPanel.add(topicPanel);
     objectPanel.add(Box.createRigidArea(new Dimension(10, 0)));
     
@@ -285,8 +286,16 @@
     rolePanel = new ObjectPanel(&quot;Roles&quot;, new EditRoleWindow(frame), solver, this);
     objectPanel.add(rolePanel);
 
+    // Set up the location panel
+    locationPanel = new ObjectPanel(&quot;Locations&quot;, new GenericEditWindow(frame, &quot;Edit Location&quot;), solver, this);
+    objectPanel.add(locationPanel);
+
+    // Set up the time panel
+    timePanel = new ObjectPanel(&quot;Times&quot;, new GenericEditWindow(frame, &quot;Edit Time&quot;), solver, this);
+    objectPanel.add(timePanel);
+
     // Set up the solution panel
-    solutionPanel = new SolutionPanel(frame, solver, this);
+    solutionPanel = new SolutionPanel(frame, solver, this, this);
     rc.weighty = 0.0;
     rootPanel.add(solutionPanel, rc);
     
@@ -295,6 +304,8 @@
     personPanel.addNameChangeListener(listener);
     topicPanel.addNameChangeListener(listener);
     rolePanel.addNameChangeListener(listener);
+    locationPanel.addNameChangeListener(listener);
+    timePanel.addNameChangeListener(listener);
   }
   
   /**
@@ -356,14 +367,14 @@
       getHelpWindow().setVisible(true);
     else if (command.equals(&quot;about&quot;))
     {
-      String date     = getSubversionString(&quot;$LastChangedDate: 2005-03-04 18:45:41Z $&quot;);
-      String revision = getSubversionString(&quot;$LastChangedRevision: 10 $&quot;);
+      String date     = getSubversionString(&quot;$LastChangedDate$&quot;);
+      String revision = getSubversionString(&quot;$LastChangedRevision$&quot;);
       
       JOptionPane.showMessageDialog(frame,
                                     programName + &quot;\n\n&quot;	
                                     + &quot;Version: 0.5 revision &quot; + revision + &quot;\n&quot; 
                                     + &quot;Created: &quot; + date + &quot;\n&quot; 
-                                    + &quot;Algorithms: Gero Scholz\n&quot;
+                                    + &quot;Algorithms: Gero Scholz, Andreas Wickner\n&quot;
                                     + &quot;User Interface: Andreas Wickner&quot;);
     }
   }
@@ -395,6 +406,8 @@
     topicPanel.hideEditor();
     personPanel.hideEditor();
     rolePanel.hideEditor();
+    locationPanel.hideEditor();
+    timePanel.hideEditor();
     solutionPanel.hideEditor();
     
     solver = new Solver(topicNumber, personNumber, roleNumber, sessionNumber);
@@ -403,6 +416,8 @@
     topicPanel.reconfigure(solver, solver.getTopics().getNames());
     personPanel.reconfigure(solver, solver.getPersons().getNames());
     rolePanel.reconfigure(solver, solver.getRoles().getNames());
+    locationPanel.reconfigure(solver, solver.getLocations().getNames());
+    timePanel.reconfigure(solver, solver.getTimes().getNames());
     solutionPanel.reconfigure(solver, solver.getSolutionNames());
 
     configInfo.setText(&quot;Configured for &quot; + topicNumber + &quot; topics, &quot;
@@ -460,13 +475,12 @@
       if (currentFile == null)
         currentFile = new File(fileChooser.getCurrentDirectory(), &quot;untitled.&quot; + fileSuffix);
       
-      System.out.println(&quot;Saving as: &quot; + currentFile.getAbsolutePath());
+      // System.out.println(&quot;Saving as: &quot; + currentFile.getAbsolutePath());
       frame.setTitle(programName + &quot; - &quot; + currentFile.getAbsolutePath());
       
       FileWriter writer = new FileWriter(currentFile);
       PrintWriter stream = new PrintWriter(writer);
       
-      stream.println(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot;);
       save(stream, 0);
       stream.close();
       clearChanges();
@@ -484,6 +498,7 @@
    */
   public void save(PrintWriter stream, int level)
   {
+    stream.println(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot;);
     stream.println(&quot;&lt;openconclave topics=\&quot;&quot; + solver.getTopics().getNumber()
                    + &quot;\&quot; persons=\&quot;&quot; + solver.getPersons().getNumber()
                    + &quot;\&quot; roles=\&quot;&quot; + solver.getRoles().getNumber()
@@ -493,6 +508,8 @@
     solver.getTopics().save(stream, level+1);
     solver.getPersons().save(stream, level+1);
     solver.getRoles().save(stream, level+1);
+    solver.getLocations().save(stream, level+1);
+    solver.getTimes().save(stream, level+1);
 
     Indenter.println(stream, level+1, &quot;&lt;solutionParameters topicClusters=\&quot;&quot;
                      + solutionPanel.getTopicClusters() + &quot;\&quot; personAssignments=\&quot;&quot;
@@ -500,6 +517,9 @@
                      + solutionPanel.getAttempts() + &quot;\&quot; keepBest=\&quot;&quot;
                      + solutionPanel.getKeepBest() + &quot;\&quot;/&gt;&quot;);
     
+    Indenter.println(stream, level+1, &quot;&lt;selectedSolution index=\&quot;&quot;
+                     + solutionPanel.getList().getSelectedIndex() + &quot;\&quot;/&gt;&quot;);
+                     		
     Indenter.println(stream, level+1, &quot;&lt;solutions&gt;&quot;);
     
     Vector solutions = solver.getSolutions();

Modified: trunk/openSess/ShowSolutionWindow.java
===================================================================
--- trunk/openSess/ShowSolutionWindow.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/ShowSolutionWindow.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -18,7 +18,7 @@
  * Copyright 2005 Andreas Wickner
  * 
  * Created:     19.02.2005
- * Revision ID: $Id: ShowSolutionWindow.java 10 2005-03-04 18:45:41Z awickner $
+ * Revision ID: $Id$
  * 
  * This file is part of OpenSess.
  * OpenSess is free software; you can redistribute it and/or modify it 
@@ -143,8 +143,11 @@
     this.solver = solver;
     this.selected = selected;
     
-    Topics topics = solver.getTopics();
-    Persons persons = solver.getPersons();
+    Topics    topics    = solver.getTopics();
+    Persons   persons   = solver.getPersons();
+    Locations locations = solver.getLocations();
+    Times     times     = solver.getTimes();
+    
     int tNumber = topics.getNumber();   // Number of topics
     int pNumber = persons.getNumber();  // Number of persons
     int sNumber = solver.getSessionNumber();   // Number of sessions
@@ -182,12 +185,12 @@
         if (g == 0)  // Column headers
         {
           if (s &gt; 0)
-            label.setText(&quot;Session &quot; + s);
+            label.setText(locations.getName(s-1));
         }
         else if (s == 0)  // Row headers
         {
           if (g &gt; 0)
-            label.setText(&quot;Group &quot; + g);
+            label.setText(times.getName(g-1));
         }
       }
      
@@ -324,7 +327,7 @@
     
     public void nameChanged(int index, String oldName, String newName)
     {
-      System.out.println(&quot;Solution update on name change &quot; + oldName + &quot; -&gt; &quot; + newName);
+      // System.out.println(&quot;Solution update on name change &quot; + oldName + &quot; -&gt; &quot; + newName);
       window.update();
     }
   }

Modified: trunk/openSess/Solution.java
===================================================================
--- trunk/openSess/Solution.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/Solution.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -6,7 +6,7 @@
  * Copyright 2005 Andreas Wickner
  * 
  * Created:     18.02.2005
- * Revision ID: $Id: Solution.java 10 2005-03-04 18:45:41Z awickner $
+ * Revision ID: $Id$
  * 
  * This file is part of OpenSess.
  * OpenSess is free software; you can redistribute it and/or modify it 
@@ -162,9 +162,12 @@
     if (this == other)
       return false;  // identical
     
-    if (this.getMeanSatisfaction() &gt; other.getMeanSatisfaction())
+    int thisMean = (int)(this.getMeanSatisfaction() * 1000);
+    int otherMean = (int)(other.getMeanSatisfaction() * 1000);
+    
+    if (thisMean &gt; otherMean)
       return true;
-    else if (this.getMeanSatisfaction() &lt; other.getMeanSatisfaction())
+    else if (thisMean &lt; otherMean)
       return false;
     
     // same mean deviation, compare max deviation

Modified: trunk/openSess/SolutionPanel.java
===================================================================
--- trunk/openSess/SolutionPanel.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/SolutionPanel.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -1,9 +1,18 @@
 package openSess;
+
 import java.awt.Component;
 import java.awt.Dimension;
 import java.awt.GridLayout;
 import java.awt.event.ActionEvent;
 import java.awt.event.ActionListener;
+import java.awt.print.PrinterJob;
+import java.io.File;
+import java.io.FileWriter;
+import java.io.IOException;
+import java.io.PrintWriter;
+import java.io.StringReader;
+import java.io.StringWriter;
+import java.net.URISyntaxException;
 import java.text.NumberFormat;
 import java.text.ParseException;
 
@@ -11,72 +20,87 @@
 import javax.swing.Box;
 import javax.swing.BoxLayout;
 import javax.swing.JButton;
+import javax.swing.JComboBox;
 import javax.swing.JFormattedTextField;
 import javax.swing.JFrame;
 import javax.swing.JLabel;
+import javax.swing.JOptionPane;
 import javax.swing.JPanel;
 import javax.swing.JScrollPane;
 import javax.swing.ProgressMonitor;
 import javax.swing.Timer;
+import javax.xml.transform.Transformer;
+import javax.xml.transform.TransformerConfigurationException;
+import javax.xml.transform.TransformerException;
+import javax.xml.transform.TransformerFactory;
+import javax.xml.transform.stream.StreamResult;
+import javax.xml.transform.stream.StreamSource;
 
 /*
  * Copyright 2005 Andreas Wickner
  * 
- * Created:     27.02.2005
- * Revision ID: $Id: SolutionPanel.java 10 2005-03-04 18:45:41Z awickner $
+ * Created: 27.02.2005 Revision ID: $Id: SolutionPanel.java 10 2005-03-04
+ * 18:45:41Z awickner $
  * 
- * This file is part of OpenSess.
- * OpenSess is free software; you can redistribute it and/or modify it 
- * under the terms of the GNU General Public License as published by 
- * the Free Software Foundation; either version 2 of the License, or 
- * (at your option) any later version.
- *
- * OpenSess is distributed in the hope that it will be useful, but 
- * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY 
- * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License 
- * for more details.
- *
- * You should have received a copy of the GNU General Public License along 
- * with OpenSess; if not, write to the Free Software Foundation, Inc., 
- * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA 
+ * This file is part of OpenSess. OpenSess is free software; you can
+ * redistribute it and/or modify it under the terms of the GNU General Public
+ * License as published by the Free Software Foundation; either version 2 of the
+ * License, or (at your option) any later version.
+ * 
+ * OpenSess is distributed in the hope that it will be useful, but WITHOUT ANY
+ * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
+ * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License along with
+ * OpenSess; if not, write to the Free Software Foundation, Inc., 59 Temple
+ * Place, Suite 330, Boston, MA 02111-1307 USA
  */
 
 /**
- * The SolutionPanel is a BorderedListPanel with additional
- * JTextFields for the calculation parameters and a button
- * to start the calculation. If this button is pressed,
- * the calculation is started in a separate task and the progress
- * is monitored with ProgressMonitor.
+ * The SolutionPanel is a BorderedListPanel with additional JTextFields for the
+ * calculation parameters and a button to start the calculation. If this button
+ * is pressed, the calculation is started in a separate task and the progress is
+ * monitored with ProgressMonitor.
  * 
  * @author andreas
  */
 public class SolutionPanel
-  extends BorderedListPanel
-  implements ActionListener
+    extends BorderedListPanel
+    implements ActionListener
 {
   private JFrame              frame;
-  private JFormattedTextField topicClustersField, personAssignmentsField, 
-                              keepBestField, attemptsField;
+  private JFormattedTextField topicClustersField, personAssignmentsField, keepBestField,
+      attemptsField;
   private JButton             solveButton;
+  private JComboBox           printFormatList;
   private ProgressMonitor     monitor;
   private Timer               timer;
-
+  private String              printDirPath = &quot;../print&quot;;
+  private XMLStateSaving      stateSaver;
+  
+  
   /**
-   * Construct a new SolutionPanel that is a child of the specified
-   * JFrame and associated with a Solver object and a ChangeMonitor.
+   * Construct a new SolutionPanel that is a child of the specified JFrame and
+   * associated with a Solver object and a ChangeMonitor.
    * 
-   * @param frame   the JFrame.
-   * @param solver  the Solver object.
-   * @param monitor the ChangeMonitor.
+   * @param frame
+   *          the JFrame.
+   * @param solver
+   *          the Solver object.
+   * @param monitor
+   *          the ChangeMonitor.
    */
-  public SolutionPanel(JFrame frame, Solver solver, ChangeMonitor monitor)
+  public SolutionPanel(JFrame frame, Solver solver, ChangeMonitor monitor,
+                       XMLStateSaving stateSaver)
   {
     super(&quot;Solutions&quot;, solver, monitor, new ShowSolutionWindow(frame),
           BoxLayout.LINE_AXIS);
-    this.frame = frame;
-
+    this.frame      = frame;
+    this.stateSaver = stateSaver;
+    
     // Create a timer for monitoring calculations
     timer = new Timer(500, new TimerListener());
+
     
     // Set up the solution list
     JPanel solListPanel = new JPanel();
@@ -90,19 +114,19 @@
     showButton.addActionListener(this);
     showButton.setAlignmentX(Component.CENTER_ALIGNMENT);
     solListPanel.add(showButton);
-    
+
     add(solListPanel);
     add(Box.createRigidArea(new Dimension(10, 0)));
 
     // Set up the solution parameter panel
     JPanel solparPanel = new JPanel();
     solparPanel.setLayout(new BoxLayout(solparPanel, BoxLayout.PAGE_AXIS));
-    
+
     NumberFormat intFormat = NumberFormat.getIntegerInstance();
-    JLabel topicClustersLabel     = new JLabel(&quot;Topic Clustering Attempts:&quot;);
+    JLabel topicClustersLabel = new JLabel(&quot;Topic Clustering Attempts:&quot;);
     JLabel personAssignmentsLabel = new JLabel(&quot;Person Assignment Attempts:&quot;);
-    JLabel attemptsLabel          = new JLabel(&quot;Maximum Assignment Attempts:&quot;);
-    JLabel keepBestLabel          = new JLabel(&quot;Keep Best Solutions:&quot;);
+    JLabel attemptsLabel = new JLabel(&quot;Maximum Assignment Attempts:&quot;);
+    JLabel keepBestLabel = new JLabel(&quot;Keep Best Solutions:&quot;);
     topicClustersField = new JFormattedTextField();
     topicClustersField.setValue(new Integer(5));
     topicClustersField.setColumns(4);
@@ -115,48 +139,96 @@
     keepBestField = new JFormattedTextField();
     keepBestField.setValue(new Integer(10));
     keepBestField.setColumns(4);
-    
+
     JPanel valuePanel = new JPanel();
     valuePanel.setLayout(new BoxLayout(valuePanel, BoxLayout.LINE_AXIS));
-    valuePanel.setBorder(BorderFactory.createEmptyBorder(10,0,10,0));
+    valuePanel.setBorder(BorderFactory.createEmptyBorder(10, 0, 10, 0));
     solparPanel.add(valuePanel);
-    
-    JPanel labelPanel = new JPanel(new GridLayout(0,1));
+
+    JPanel labelPanel = new JPanel(new GridLayout(0, 1));
     valuePanel.add(labelPanel);
     labelPanel.add(topicClustersLabel);
     labelPanel.add(personAssignmentsLabel);
     labelPanel.add(attemptsLabel);
     labelPanel.add(keepBestLabel);
     valuePanel.add(Box.createRigidArea(new Dimension(10, 0)));
-    
-    JPanel fieldPanel = new JPanel(new GridLayout(0,1));
+
+    JPanel fieldPanel = new JPanel(new GridLayout(0, 1));
     valuePanel.add(fieldPanel);
     fieldPanel.add(topicClustersField);
     fieldPanel.add(personAssignmentsField);
     fieldPanel.add(attemptsField);
     fieldPanel.add(keepBestField);
-    
+
     solveButton = new JButton(&quot;Solve&quot;);
     solveButton.setActionCommand(&quot;solve&quot;);
     solveButton.addActionListener(this);
     solveButton.setAlignmentX(Component.CENTER_ALIGNMENT);
     solparPanel.add(solveButton);
+    solparPanel.add(Box.createRigidArea(new Dimension(0, 10)));
+
+    JLabel printFormatLabel = new JLabel(&quot;Print format:&quot;);
+    printFormatLabel.setMaximumSize(new Dimension(Short.MAX_VALUE,
+                                      Short.MAX_VALUE));    
+    printFormatLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
+    solparPanel.add(printFormatLabel);
     
+    printFormatList = new JComboBox();
+    getPrintFormats();  // Read available print formats
+    printFormatList.addActionListener(this);
+    printFormatList.setAlignmentX(Component.CENTER_ALIGNMENT);
+    solparPanel.add(printFormatList);
+    solparPanel.add(Box.createRigidArea(new Dimension(0, 10)));
+
+    JButton printButton = new JButton(&quot;Print&quot;);
+    printButton.setActionCommand(&quot;print&quot;);
+    printButton.addActionListener(this);
+    printButton.setAlignmentX(Component.CENTER_ALIGNMENT);
+    solparPanel.add(printButton);
+    
     Dimension minSize = new Dimension(0, 0);
     Dimension prefSize = new Dimension(0, Short.MAX_VALUE);
     solparPanel.add(new Box.Filler(minSize, prefSize, prefSize));
-    // solparPanel.add(Box.createVerticalGlue());
     add(solparPanel);
   }
+
+  /**
+   * Read the list of available print formats.
+   *
+   */
+  protected void getPrintFormats()
+  {
+    try
+    {
+      // Locate the print directory and get the contained files
+      File printDir = new File(getClass().getResource(printDirPath).toURI());
+      String files[] = printDir.list();
+
+      for (int n = 0; n &lt; files.length; ++n)
+        if (files[n].endsWith(&quot;.xsl&quot;))
+        {
+          int p = files[n].lastIndexOf(&quot;.xsl&quot;);
+          String format = files[n].substring(0, p);
+          printFormatList.addItem(format);
+        }
+    }
+    catch (URISyntaxException e)
+    {
+      System.out.println(&quot;Problem reading print formats: URL -&gt; URI conversion.&quot;);
+    }
+  }
   
   /**
-   * Sets the parameters for solution finding.
-   * The number of solutions will usually be topicClusters*personAssignments,
-   * but might be slightly less if some solution attempts were not successful.
+   * Sets the parameters for solution finding. The number of solutions will
+   * usually be topicClusters*personAssignments, but might be slightly less if
+   * some solution attempts were not successful.
    * 
-   * @param topicClusters     the number of topic clusterings to try.
-   * @param personAssignments the number of person assignments to try.
-   * @param keepBest          the number of best solutions to keep in the list.
+   * @param topicClusters
+   *          the number of topic clusterings to try.
+   * @param personAssignments
+   *          the number of person assignments to try.
+   * @param keepBest
+   *          the number of best solutions to keep in the list.
    */
   public void setSolutionParameters(int topicClusters, int personAssignments,
                                     int attempts, int keepBest)
@@ -169,6 +241,7 @@
 
   /**
    * Return the number of topic clusters.
+   * 
    * @return the number of topic clusters.
    */
   public int getTopicClusters()
@@ -178,6 +251,7 @@
 
   /**
    * Return the number of person assignments.
+   * 
    * @return the number of person assignments.
    */
   public int getPersonAssignments()
@@ -187,6 +261,7 @@
 
   /**
    * Return the maximum number of person assignments.
+   * 
    * @return the number of assignment attempts.
    */
   public int getAttempts()
@@ -196,17 +271,19 @@
 
   /**
    * Return the number of best solutions to keep in the list.
+   * 
    * @return the number of assignment attempts.
    */
   public int getKeepBest()
   {
     return getIntFromField(keepBestField);
   }
-  
+
   /**
    * Get the value of a JFormattedField as an int.
    * 
-   * @param field the field.
+   * @param field
+   *          the field.
    * @return the value, converted to int.
    */
   protected int getIntFromField(JFormattedTextField field)
@@ -218,61 +295,180 @@
     catch (ParseException ex)
     {
     }
-    
-    return ((Integer)field.getValue()).intValue();
+
+    return ((Integer) field.getValue()).intValue();
   }
-  
+
   /**
-   * Process the command &quot;solve&quot; which start a calculation and
-   * forward all other commands to the base class.
+   * Process the command &quot;solve&quot; which start a calculation and forward all other
+   * commands to the base class.
    */
   public void processCommand(String command)
   {
     if (command.equals(&quot;solve&quot;))
     {
-      int topicClusters     = getTopicClusters();
-      int personAssignments = getPersonAssignments();
-      int attempts          = getAttempts();
-      int keepBest          = getKeepBest();
-      
-      monitor = new ProgressMonitor(frame, &quot;Calculating Solutions...&quot;, &quot;&quot;, 0,
-                                    topicClusters * personAssignments);
-      monitor.setProgress(0);
-      monitor.setMillisToDecideToPopup(0);
-      solveButton.setEnabled(false);
-      getSolver().startSolverTask(topicClusters, personAssignments, attempts, keepBest);
-      timer.start();
-      getChangeMonitor().signalChange();
+      if (checkConstraints())
+      {
+        int topicClusters = getTopicClusters();
+        int personAssignments = getPersonAssignments();
+        int attempts = getAttempts();
+        int keepBest = getKeepBest();
+
+        monitor = new ProgressMonitor(frame, &quot;Calculating Solutions...&quot;, &quot;&quot;, 0,
+                                      topicClusters * personAssignments);
+        monitor.setProgress(0);
+        monitor.setMillisToDecideToPopup(0);
+        solveButton.setEnabled(false);
+        getSolver().startSolverTask(topicClusters, personAssignments, attempts, keepBest);
+        timer.start();
+        getChangeMonitor().signalChange();
+      }
     }
+    else if (command.equals(&quot;print&quot;))
+    {
+      try
+      {
+        // get selected print format
+        String printFormat = (String) printFormatList.getSelectedItem();
+        String formatterPath = printDirPath + &quot;/&quot; + printFormat + &quot;.xsl&quot;;
+        File printFormatter = new File(getClass().getResource(formatterPath).toURI());
+        
+        TransformerFactory transFactory = TransformerFactory.newInstance();
+        Transformer transformer = transFactory.newTransformer(new StreamSource(printFormatter));
+        
+        // turn our internal state into an XML string
+        StringWriter xmlState = new StringWriter();
+        PrintWriter  xmlWriter = new PrintWriter(xmlState);
+        stateSaver.save(xmlWriter, 0);
+        
+        // Construct a Transformer source that contains the XML string
+        StreamSource source = new StreamSource(new StringReader(xmlState.toString()));
+        
+        // Construct a Result that writes to a string
+        StringWriter htmlData = new StringWriter();
+        StreamResult result = new StreamResult(htmlData);
+        
+        // Create the HTML document
+        transformer.transform(source, result);
+
+        FileWriter testWriter = new FileWriter(&quot;test.html&quot;);
+        PrintWriter testStream = new PrintWriter(testWriter);
+        testStream.println(htmlData.toString());
+        testStream.close();
+        
+        // Construct the printable object from the HTML string
+        HTMLPrinter htmlPrinter = new HTMLPrinter(htmlData.toString());
+
+        PrinterJob job = PrinterJob.getPrinterJob();
+        job.setPrintable(htmlPrinter);
+        
+        if (job.printDialog()) /* Displays the standard system print dialog */
+        {
+          try
+          {
+            job.print();
+          }
+          catch (Exception ex)
+          {
+            System.out.println(ex);
+          }
+        }
+      }
+      catch (URISyntaxException e)
+      {
+        System.out.println(&quot;Problem using print format: &quot; + e);
+      }
+      catch (IOException e)
+      {
+        System.out.println(&quot;I/O-Problem: &quot; + e);
+      }
+      catch (TransformerConfigurationException e)
+      {
+        System.out.println(&quot;Cannot create transformer: &quot; + e);
+      }
+      catch (TransformerException e)
+      {
+        System.out.println(&quot;TransformerException: &quot; + e);
+      }
+    }
     else
       super.processCommand(command);
   }
-  
 
   /**
-   * This class is an ActionListener which is only triggered for timer
-   * events. It is used to provide feedback on the progress of a 
-   * solution calculation and also detects when the calculation is
-   * finished.
+   * Check any constraints that must be met on order for the calculation to work
+   * as expected.
+   * 
+   * @return true if the constraints are met, false otherwise.
    */
+  protected boolean checkConstraints()
+  {
+    boolean ok = true;
+    StringBuffer msg = new StringBuffer(&quot;The following constraints are violated:\n&quot;);
+    Solver solver = getSolver();
+    Roles roles = solver.getRoles();
+    int dimRoles = roles.getNumber();
+    int dimPersons = solver.getPersons().getNumber();
+    int dimSessions = solver.getSessionNumber();
+    int minSum = 0;
+    int maxSum = 0;
+    int perSession = dimPersons / dimSessions;
+
+    for (int r = 0; r &lt; dimRoles; ++r)
+    {
+      minSum += roles.getMinimumPerSession(r);
+      maxSum += roles.getMaximumPerSession(r);
+    }
+
+    if (maxSum &lt; perSession)
+    {
+      ok = false;
+      msg.append(&quot;  - The sum of the role maxima (&quot; + maxSum
+                 + &quot;) is less than\n    the number of participants per session (&quot;
+                 + perSession + &quot;)\n&quot;);
+    }
+
+    if (minSum &gt; perSession)
+    {
+      ok = false;
+      msg.append(&quot;  - The sum of the role minima (&quot; + minSum
+                 + &quot;) exceeds\n    the number of participants per session (&quot; + perSession
+                 + &quot;)\n&quot;);
+    }
+
+    if (!ok)
+    {
+      msg.append(&quot;Please correct these problems before trying again.&quot;);
+      JOptionPane.showMessageDialog(this, msg, &quot;Constraint Violation&quot;,
+                                    JOptionPane.ERROR_MESSAGE);
+    }
+
+    return ok;
+  }
+
+  /**
+   * This class is an ActionListener which is only triggered for timer events.
+   * It is used to provide feedback on the progress of a solution calculation
+   * and also detects when the calculation is finished.
+   */
   private class TimerListener
-    implements ActionListener
+      implements ActionListener
   {
     /**
-     * When called, update the progress bar of the ProgressMonitor
-     * and display any progress messages. If the calculation has
-     * been canceled or terminated, do the neccessary cleanup work.
+     * When called, update the progress bar of the ProgressMonitor and display
+     * any progress messages. If the calculation has been canceled or
+     * terminated, do the neccessary cleanup work.
      */
     public void actionPerformed(ActionEvent e)
     {
       Solver solver = getSolver();
       monitor.setProgress(solver.getCurrent());
       String s = solver.getMessage();
-      
-      if (s != null) 
+
+      if (s != null)
         monitor.setNote(s);
 
-      if (monitor.isCanceled() || solver.isDone()) 
+      if (monitor.isCanceled() || solver.isDone())
       {
         monitor.close();
         solver.stop();

Modified: trunk/openSess/Solver.java
===================================================================
--- trunk/openSess/Solver.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/Solver.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -2,7 +2,7 @@
  * Copyright 2005 Gero Scholz, Andreas Wickner
  * 
  * Created:     2005-02-11 
- * Revision ID: $Id: Solver.java 10 2005-03-04 18:45:41Z awickner $
+ * Revision ID: $Id$
  * 
  * 2005-02-14/AW: Changes to decrease excessive memory allocation/deallocation
  * 2005-02-22/GS: Algorithm bug fixes
@@ -58,6 +58,8 @@
   private Topics           topics;
   private Persons          persons;
   private Roles            roles;
+  private Locations        locations;
+  private Times            times;
   private Vector           solutions;
   private DefaultListModel solutionNames;
   private int              dimTryTopicClustering;
@@ -72,6 +74,7 @@
   private int              seqPersons[][];
   private NumberFormat     compactFormat;
   private boolean          solved;
+  private int              candidates[];
   
   /*
    * currently there is a tendency to find an ideal solution for some persons
@@ -94,8 +97,11 @@
     topics        = new Topics(this, dimTopics);
     persons       = new Persons(this, dimPersons, dimTopics);
     roles         = new Roles(dimRoles, dimPersons, dimSessions);
+    locations     = new Locations(dimSessions);
+    times         = new Times(dimPersons / dimSessions);
     solutions     = new Vector();
     solutionNames = new DefaultListModel();
+    candidates    = new int[dimPersons];
   }
 
   /**
@@ -150,6 +156,26 @@
   }
   
   /**
+   * Return the number of locations.
+   * 
+   * @return the number of locations.
+   */
+  public Locations getLocations()
+  {
+    return locations;
+  }
+  
+  /**
+   * Return the number of times.
+   * 
+   * @return the number of times.
+   */
+  public Times getTimes()
+  {
+    return times;
+  }
+  
+  /**
    * Return the list of solutions.
    * 
    * @return the list of solutions.
@@ -357,8 +383,8 @@
     
     // Prepare a number formatter
     compactFormat = NumberFormat.getInstance();
-    compactFormat.setMinimumFractionDigits(2);
-    compactFormat.setMaximumFractionDigits(2);
+    compactFormat.setMinimumFractionDigits(3);
+    compactFormat.setMaximumFractionDigits(3);
     
     if (debug)
     {
@@ -724,21 +750,22 @@
     if (debug)
     	System.out.println(&quot;For each session, there are &quot; + rolePool.size() + &quot; roles in the pool of optional roles.&quot;);
     
-    // First, we go through each session and assign the roles with a minimum occurence
-    for (int t=0;  t &lt; topics.getNumber();  ++t)
-      for (int r=0;  r &lt; roles.getNumber();  ++r)
-        for (int n=0;  n &lt; roles.getMinimumPerSession(r);  ++n)
-          solution.setRole(chooseMostInterestedPerson(t), t, r+1);
-
-    if (debug)
-    	System.out.println(&quot;\nAfter assigning the required roles:\n&quot; + solution.debugString());
+    // Prepare the vector which tells us how many copies of each
+    // role should be assigned in a session
+    int rolesToAssign[] = new int[dimRoles];
     
-    // Now, we distribute the optional roles for each session
+    // We iterate over all sessions to assign the roles
     for (int t=0;  t &lt; topics.getNumber();  ++t)
     {
-      // Make a copy of the complete rolePool
-      Vector pool = (Vector) rolePool.clone();
+      int minimumRoles = 0;
       
+      // Initialise the role array with the minimum numbers.
+      for (int r=0;  r &lt; dimRoles;  ++r)
+      {
+        rolesToAssign[r] = roles.getMinimumPerSession(r);
+        minimumRoles += rolesToAssign[r];
+      }
+      
       // Count the unassigned persons in this session
       // (this is done to enable this algorithm to cope with a varying 
       // number of participants per session).
@@ -747,25 +774,33 @@
       for (int p=0;  p &lt; persons.getNumber();  ++p)
         if (solution.getRole(p, t) == unassignedRole)
           ++unassigned;
-        
-      // Randomly remove roles from the pool until we have the right number
-      while (pool.size() &gt; unassigned)
-      {
-        int index = rand.nextInt(pool.size());
-        pool.remove(index);
-      }
+    
+      int optionalRoles = unassigned - minimumRoles;
+      
+      if (debug)
+      	System.out.println(&quot;For session &quot; + t + &quot; there are &quot; + optionalRoles + 
+      	                   &quot; optional roles to pick.&quot;);
+      
+      // Pick the optional roles randomly and increase rolesToAssign accordingly
+      // First, make a copy of the complete rolePool
+      Vector pool = (Vector) rolePool.clone();
+      
+      if (optionalRoles &gt; pool.size())
+        System.out.println(&quot;CANNOT HAPPEN: pool size wrong.&quot;);
 
-      if (pool.size() != unassigned)
-        System.out.println(&quot;CANNOT HAPPEN: pool size wrong.&quot;);
-      
-      // Assign the remaining roles in the pool
-      while (pool.size() &gt; 0)  
+      for (int n=0;  n &lt; optionalRoles;  ++n)  
       {
         int index = rand.nextInt(pool.size());
         int r     = ((Integer)pool.elementAt(index)).intValue();
         pool.remove(index);
-        solution.setRole(chooseMostInterestedPerson(t), t, r+1);
+        ++rolesToAssign[r];
       }
+
+      // Now we know what roles must be assigned.
+      // Do it by picking the participants that are most interested.
+      for (int r=0;  r &lt; dimRoles;  ++r)
+        for (int n=0;  n &lt; rolesToAssign[r];  ++n)
+          solution.setRole(chooseMostInterestedPerson(t, rand), t, r+1);
     }
     
     if (debug)
@@ -783,27 +818,34 @@
    * @param t the topic of the session.
    * @return the most interested unassigned pearticipant.
    */
-  protected int chooseMostInterestedPerson(int t)
+  protected int chooseMostInterestedPerson(int t, Random rand)
   {
     // Of all the unassigned persons in this session,
     // pick the one with the highest interest.
     int dimRoles       = getRoles().getNumber();
     int unassignedRole = dimRoles + 1; // Marker for an unassigned role
-    int bestPerson = -1;
     int interest = 99999;
+    int dimCandidates = 0;
     
     for (int p=0;  p &lt; persons.getNumber();  ++p)
       if (solution.getRole(p, t) == unassignedRole)
-        if (persons.getPreferenceIndex(p, t) &lt; interest)
+      {
+        int pInterest = persons.getPreferenceIndex(p, t);
+        
+        if (pInterest &lt; interest)
         {
-        	bestPerson = p;
-        	interest   = persons.getPreferenceIndex(p, t);
+          dimCandidates = 0;
+          candidates[dimCandidates++] = p;
+        	interest   = pInterest;
         }
-        
-    if (bestPerson &lt; 0)
+        else if (pInterest == interest)
+          candidates[dimCandidates++] = p;
+      }
+      
+    if (dimCandidates &lt;= 0)
       System.out.println(&quot;CANNOT HAPPEN: no person left to choose.&quot;);
         
-    return bestPerson;
+    return candidates[rand.nextInt(dimCandidates)];
   }
 
   /**

Modified: trunk/openSess/SolverConstructor.java
===================================================================
--- trunk/openSess/SolverConstructor.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/SolverConstructor.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -6,7 +6,7 @@
  * Copyright 2005 Andreas Wickner
  * 
  * Created:     21.02.2005
- * Revision ID: $Id: SolverConstructor.java 10 2005-03-04 18:45:41Z awickner $
+ * Revision ID: $Id$
  * 
  * This file is part of OpenSess.
  * OpenSess is free software; you can redistribute it and/or modify it 
@@ -38,6 +38,8 @@
   private int        topic      = 0;
   private int        person     = 0;
   private int        role       = 0;
+  private int        location   = 0;
+  private int        time       = 0;
   private int        solution   = 0;
   private int        group      = 0;
   private int        groupIndex = 0;
@@ -93,6 +95,14 @@
       roles.setMinimumPerSession(role, getInt(attributes, &quot;min&quot;, minmax));
       roles.setMaximumPerSession(role, getInt(attributes, &quot;max&quot;, minmax));
     }
+    else if (qName.equals(&quot;locations&quot;))
+      location = -1;
+    else if (qName.equals(&quot;location&quot;))
+      solver.getLocations().setName(++location, getString(attributes, &quot;name&quot;, location));
+    else if (qName.equals(&quot;times&quot;))
+      time = -1;
+    else if (qName.equals(&quot;time&quot;))
+      solver.getTimes().setName(++time, getString(attributes, &quot;name&quot;, time));
     else if (qName.equals(&quot;preferredTopic&quot;))
       solver.getPersons().setPreference(person, ++topic, getInt(attributes, &quot;index&quot;, 0));
     else if (qName.equals(&quot;solutionParameters&quot;))

Added: trunk/openSess/Times.java
===================================================================
--- trunk/openSess/Times.java	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/openSess/Times.java	2005-04-26 13:53:57 UTC (rev 20)
@@ -0,0 +1,105 @@
+/*
+ * Copyright 2005 Andreas Wickner
+ * 
+ * Created:     2005-04-17 
+ * Revision ID: $Id$
+ * 
+ * This file is part of OpenSess.
+ * OpenSess is free software; you can redistribute it and/or modify it 
+ * under the terms of the GNU General Public License as published by 
+ * the Free Software Foundation; either version 2 of the License, or 
+ * (at your option) any later version.
+ *
+ * OpenSess is distributed in the hope that it will be useful, but 
+ * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY 
+ * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License 
+ * for more details.
+ *
+ * You should have received a copy of the GNU General Public License along 
+ * with OpenSess; if not, write to the Free Software Foundation, Inc., 
+ * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA 
+ */
+package openSess;
+
+import java.io.PrintWriter;
+
+import javax.swing.DefaultListModel;
+
+/**
+ * @author andreas
+ *
+ */
+public class Times
+  implements XMLStateSaving
+{
+  private DefaultListModel names;
+
+  /**
+   * Constructs a new Times object.
+   * 
+   * @param dimTimes the number of times.
+   */
+  public Times(int dimTimes)
+  {
+    names = new DefaultListModel();
+    
+    for (int p = 0; p &lt; dimTimes; p++)
+      names.addElement(&quot;Time &quot; + (p+1));
+  }
+
+
+  /**
+   * Returns the number of times.
+   * 
+   * @return the number of times.
+   */
+  public int getNumber()
+  {
+    return names.getSize();
+  }
+  
+  /**
+   * Returns all time names as a DefaultListModel.
+   * 
+   * @return a list of all time names.
+   */
+  public DefaultListModel getNames()
+  {
+    return names;
+  }
+  
+  /**
+   * Returns the name of the time with a given index.
+   * 
+   * @param index the index of the time
+   * @return the name of the time.
+   */
+  public String getName(int index)
+  {
+    return (String)names.getElementAt(index);
+  }
+  
+  /**
+   * Set the name of a time.
+   * 
+   * @param time the time number.
+   * @param name     the new name.
+   */
+  protected void setName(int time, String name)
+  {
+    names.setElementAt(name, time);
+  }
+  
+  /**
+   * Save the Times data in XML form.
+   */
+  public void save(PrintWriter stream, int level)
+  {
+    Indenter.println(stream, level, &quot;&lt;times&gt;&quot;);
+
+    for (int p = 0;  p &lt; getNumber();  ++p)
+      Indenter.println(stream, level+1, &quot;&lt;time name=\&quot;&quot; + getName(p) + &quot;\&quot;/&gt;&quot;);
+    
+    Indenter.println(stream, level, &quot;&lt;/times&gt;&quot;);
+  }
+}

Added: trunk/print/Details.xsl
===================================================================

Added: trunk/print/Overview.xsl
===================================================================
--- trunk/print/Overview.xsl	2005-04-11 12:11:39 UTC (rev 19)
+++ trunk/print/Overview.xsl	2005-04-26 13:53:57 UTC (rev 20)
@@ -0,0 +1,79 @@
+&lt;xsl:stylesheet version = '1.0' xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&gt;
+
+&lt;xsl:variable name=&quot;sessions&quot; select=&quot;/openconclave/@sessions&quot;/&gt;
+&lt;xsl:variable name=&quot;s&quot; select=&quot;//selectedSolution/@index&quot;/&gt;
+&lt;xsl:variable name=&quot;sol&quot; select=&quot;//solution[position() = $s]&quot;/&gt;
+
+&lt;xsl:template match=&quot;/&quot;&gt;
+  &lt;html&gt;
+  &lt;head&gt;
+    &lt;title&gt;OpenSess Solution Overview&lt;/title&gt;
+  &lt;/head&gt;
+  &lt;body&gt;
+    &lt;h1&gt;
+      OpenSess Solution Overview
+    &lt;/h1&gt;
+
+    &lt;table&gt;
+      &lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;xsl:apply-templates select=&quot;//topic&quot; mode=&quot;names&quot;/&gt;&lt;/tr&gt;
+      &lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;xsl:apply-templates select=&quot;//topic&quot; mode=&quot;times&quot;/&gt;&lt;/tr&gt;
+      &lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;xsl:apply-templates select=&quot;//topic&quot; mode=&quot;locations&quot;/&gt;&lt;/tr&gt;
+      &lt;xsl:apply-templates select=&quot;//person&quot;/&gt;
+    &lt;/table&gt;    
+  &lt;/body&gt;
+  &lt;/html&gt; 
+&lt;/xsl:template&gt;
+
+&lt;xsl:template match=&quot;topic&quot; mode=&quot;names&quot;&gt;
+  &lt;xsl:variable name=&quot;t&quot; select=&quot;position()&quot;/&gt;
+  &lt;td&gt;
+    &lt;xsl:value-of select=&quot;//topic[position() = $t]/@name&quot;/&gt;
+  &lt;/td&gt;
+&lt;/xsl:template&gt;
+
+&lt;xsl:template match=&quot;topic&quot; mode=&quot;times&quot;&gt;
+  &lt;xsl:variable name=&quot;t&quot; select=&quot;position()-1&quot;/&gt;
+  &lt;td&gt;
+    &lt;xsl:for-each select=&quot;$sol//topicGroup&quot;&gt;
+      &lt;xsl:if test=&quot;groupTopic[@index = $t]&quot;&gt;
+        &lt;xsl:variable name=&quot;group&quot; select=&quot;position()&quot;/&gt;
+        &lt;xsl:value-of select=&quot;//time[position() = $group]/@name&quot;/&gt;
+      &lt;/xsl:if&gt;
+    &lt;/xsl:for-each&gt;
+  &lt;/td&gt;
+&lt;/xsl:template&gt;
+
+&lt;xsl:template match=&quot;topic&quot; mode=&quot;locations&quot;&gt;
+  &lt;xsl:variable name=&quot;t&quot; select=&quot;position()-1&quot;/&gt;
+  &lt;td&gt;
+    &lt;xsl:for-each select=&quot;$sol//groupTopic&quot;&gt;
+      &lt;xsl:if test=&quot;@index = $t&quot;&gt;
+       &lt;xsl:variable name=&quot;target&quot; select=&quot;.&quot;/&gt;
+         &lt;xsl:variable name=&quot;session&quot; select=&quot;((position()-1) mod $sessions) + 1&quot;/&gt;
+        &lt;xsl:value-of select=&quot;//location[position() = $session]/@name&quot;/&gt;
+       &lt;/xsl:if&gt;
+    &lt;/xsl:for-each&gt;
+  &lt;/td&gt;
+&lt;/xsl:template&gt;
+
+&lt;xsl:template match=&quot;person&quot;&gt;
+  &lt;xsl:variable name=&quot;p&quot; select=&quot;position()-1&quot;/&gt;
+
+  &lt;tr&gt;
+    &lt;td&gt;&lt;xsl:value-of select=&quot;@name&quot;/&gt;&lt;/td&gt;
+       
+    &lt;xsl:for-each select=&quot;//topic&quot;&gt;
+      &lt;xsl:variable name=&quot;t&quot; select=&quot;position()-1&quot;/&gt;
+      &lt;xsl:variable name=&quot;assign&quot; select=&quot;$sol//roleAssignment[@person = $p and @topic = $t]&quot;/&gt;
+      &lt;td&gt;&lt;xsl:choose&gt;
+            &lt;xsl:when test=&quot;$assign&quot;&gt;
+              &lt;xsl:value-of select=&quot;//role[position() = $assign/@role]/@name&quot;/&gt;
+            &lt;/xsl:when&gt;
+            &lt;xsl:otherwise&gt; - &lt;/xsl:otherwise&gt;
+          &lt;/xsl:choose&gt;
+      &lt;/td&gt;
+    &lt;/xsl:for-each&gt;  
+  &lt;/tr&gt;    
+&lt;/xsl:template&gt;
+
+&lt;/xsl:stylesheet&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000014.html">[Opensess-svn] r19 - trunk/openSess
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15">[ date ]</a>
              <a href="thread.html#15">[ thread ]</a>
              <a href="subject.html#15">[ subject ]</a>
              <a href="author.html#15">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/opensess-svn">More information about the Opensess-svn
mailing list</a><br>
</body></html>
